# ElSol Challenge - Medical Conversation BOT

Sistema de procesamiento de conversaciones m√©dicas que transcribe audio, extrae informaci√≥n estructurada y proporciona un chatbot inteligente basado en datos vectorizados.

> **Nota**: Este es un fork del proyecto original de [David-Sol-AI/ElSol-Challenge](https://github.com/David-Sol-AI/ElSol-Challenge)

## Caracter√≠sticas Principales

- **Transcripci√≥n de Audio**: Procesamiento autom√°tico de archivos de audio (.wav, .mp3, .m4a, .flac)
- **Extracci√≥n de Informaci√≥n**: An√°lisis autom√°tico de datos del paciente (nombre, edad, s√≠ntomas, medicamentos)
- **Base de Datos Vectorial**: Almacenamiento sem√°ntico usando ChromaDB
- **Chatbot Inteligente**: Asistente m√©dico basado en Google Gemini que responde consultas contextuales
- **API REST**: Interfaz completa con documentaci√≥n autom√°tica

## Arquitectura del Sistema

```mermaid
graph LR
    A[Audio File] --> B[FastAPI]
    B --> C[Whisper]
    C --> D[ChromaDB]
    B --> E[Gemini Chat]
    E --> D
    D --> F[Response]
```

## Prerrequisitos

- Python 3.8+
- FFmpeg instalado y configurado
- Cuenta de Google Cloud con API de Gemini habilitada

## Instalaci√≥n

1. **Clonar el repositorio**
   ```bash
   git clone <repository-url>
   cd ElSol-Challenge
   ```

2. **Crear entorno virtual**
   ```bash
   python -m venv venv
   venv\Scripts\activate  # Windows
   source venv/bin/activate  # Linux/Mac
   ```

3. **Instalar dependencias**
   ```bash
   pip install -r requirements.txt
   ```

4. **Configurar variables de entorno**
   Crear archivo `.env` en la ra√≠z del proyecto:
   ```env
   GEMINI_API_KEY=tu_api_key_de_gemini
   ```

## Ejecuci√≥n

### Modo Completo (Recomendado) - API + Bot
```bash
python main.py
```
- Inicia API autom√°ticamente
- Inicia Bot de Telegram autom√°ticamente (10s delay)
- API: http://localhost:8000
- Bot: @ElSolMedicalApi_bot

### Solo API
```bash
python main.py --api
```
- Servidor disponible en: http://localhost:8000
- Documentaci√≥n autom√°tica: http://localhost:8000/docs

### API + Bot (Expl√≠cito)
```bash
python main.py --bot
```
- Igual que el modo por defecto
- √ötil para ser expl√≠cito sobre la funcionalidad

## Interfaz de Usuario - Bot de Telegram

### ü§ñ ElSol Medical Bot
- **Bot de Telegram**: [@ElSolMedicalApi_bot](https://t.me/ElSolMedicalApi_bot)
- **Ubicaci√≥n**: `services/telegram_bot.py`
- **Funcionalidad**: Interfaz de usuario completa para el sistema
- **Ventajas del Bot**:
  - **Interfaz nativa m√≥vil**: Sin necesidad de desarrollar p√°gina web
  - **Escalable**: F√°cil expansi√≥n para recibir im√°genes y documentos
  - **Interacci√≥n natural**: Chat conversacional intuitivo
  - **Auto-inicio**: Se ejecuta autom√°ticamente con la API
  - **Mensajes inteligentes**: Contextuales seg√∫n tipo de consulta

### Caracter√≠sticas T√©cnicas
- **Archivos de audio**: .mp3, .wav, .m4a, .flac, .ogg
- **Notas de voz**: Conversi√≥n autom√°tica .ogg ‚Üí .wav con FFmpeg
- **Chat m√©dico**: Integraci√≥n completa con Google Gemini
- **Estad√≠sticas**: Consulta del estado del sistema
- **Nombres de pacientes**: Opcional via descripci√≥n de audio

### Comandos del Bot
- `/start` - Iniciar el bot y ver bienvenida
- `/help` - Mostrar ayuda y comandos disponibles
- `/chat <pregunta>` - Realizar consulta m√©dica
- `/stats` - Ver estad√≠sticas del sistema
- **Enviar audio** - Transcribir conversaci√≥n m√©dica
- **Enviar audio con descripci√≥n** - Usar el texto como nombre del paciente

## Endpoints de la API

### 1. Health Check
- **GET** `/`
- **Descripci√≥n**: Verifica el estado del servidor
- **Respuesta**: Informaci√≥n del sistema y endpoints disponibles

### 2. Procesamiento de Audio
- **POST** `/process-audio`
- **Descripci√≥n**: Sube un archivo de audio, lo transcribe y almacena la informaci√≥n
- **Par√°metros**: `file` (archivo de audio)
- **Respuesta**: Confirmaci√≥n de procesamiento exitoso

### 3. Chat Inteligente
- **POST** `/chat`
- **Descripci√≥n**: Chatbot m√©dico que responde consultas basadas en datos vectorizados
- **Par√°metros**: `question` (pregunta del usuario)
- **Respuesta**: Respuesta contextual del asistente m√©dico

## Arquitectura del Sistema

### Componentes Principales

```mermaid
graph TB
    subgraph "Interfaces de Usuario"
        BOT[ü§ñ Bot de Telegram<br/>@ElSolMedicalApi_bot]
        API_CLIENT[üíª Cliente API<br/>HTTP/REST]
    end
    
    subgraph "Capa de API"
        FASTAPI[‚ö° FastAPI Server<br/>Puerto 8000]
        EP1[üìÅ /process-audio]
        EP2[üí¨ /chat]
    end
    
    subgraph "Capa de Servicios"
        TELEGRAM[üì± TelegramBotService]
        TRANSCRIPTION[üé§ TranscriptionService]
        CHAT[üß† ChatService]
        VECTOR[üóÑÔ∏è VectorStoreService]
    end
    
    subgraph "Modelos AI"
        WHISPER[üîä OpenAI Whisper<br/>Modelo Local]
        GEMINI[üíé Google Gemini<br/>API REST]
    end
    
    subgraph "Base de Datos"
        CHROMA[(üìä ChromaDB<br/>Vector Database)]
    end
    
    %% Flujos de Telegram Bot
    BOT -->|Audio/Texto| TELEGRAM
    TELEGRAM -->|Audio| EP1
    TELEGRAM -->|Consulta| EP2
    
    %% Flujos de API Directa
    API_CLIENT -->|Audio| EP1
    API_CLIENT -->|Consulta| EP2
    
    %% Procesamiento de Audio
    EP1 --> TRANSCRIPTION
    TRANSCRIPTION --> WHISPER
    TRANSCRIPTION --> VECTOR
    VECTOR --> CHROMA
    
    %% Procesamiento de Chat
    EP2 --> CHAT
    CHAT --> GEMINI
    CHAT --> VECTOR
    
    %% Conexiones FastAPI
    FASTAPI --> EP1
    FASTAPI --> EP2
    
    %% Estilos
    classDef interfaceStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px
    classDef apiStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef serviceStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef aiStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef dbStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    class BOT,API_CLIENT interfaceStyle
    class FASTAPI,EP1,EP2 apiStyle
    class TELEGRAM,TRANSCRIPTION,CHAT,VECTOR serviceStyle
    class WHISPER,GEMINI aiStyle
    class CHROMA dbStyle
```

### Flujo de Datos

1. **Audio Processing**: Bot/API ‚Üí TranscriptionService ‚Üí Whisper ‚Üí VectorStore ‚Üí ChromaDB
2. **Chat Queries**: Bot/API ‚Üí ChatService ‚Üí Gemini + VectorStore ‚Üí Respuesta
3. **Integration**: Bot de Telegram act√∫a como interfaz nativa m√≥vil

## Casos de Uso del Chatbot

### Consultas M√©dicas
- "¬øCu√°ntos pacientes hay registrados?"
- "¬øQu√© s√≠ntomas tiene Juan P√©rez?"
- "¬øQu√© pacientes tienen fiebre?"
- "¬øHay pacientes con diabetes?"
- "Cr√©ame un plan de cuidado para Juan P√©rez"

### Consultas No M√©dicas
- "¬øQu√© hora es?"
- "Hola, ¬øc√≥mo est√°s?"
- El chatbot responde de manera natural sin usar informaci√≥n m√©dica

## Demostraci√≥n del Sistema

### Capturas de Pantalla del Bot de Telegram

> **Nota**: Aqu√≠ se incluir√°n capturas de pantalla de las pruebas del chatbot en Telegram

#### Interfaz del Bot
- Captura del comando `/start` y mensaje de bienvenida
- Captura del comando `/help` con lista de comandos disponibles
- Captura del comando `/stats` mostrando estad√≠sticas del sistema

#### Procesamiento de Audio
- Captura del env√≠o de archivo de audio (.mp3, .wav, .ogg)
- Captura del procesamiento con mensaje de confirmaci√≥n
- Captura del resultado con nombre del paciente extra√≠do

#### Chat Inteligente
- Captura de consulta m√©dica: "¬øCu√°ntos pacientes tenemos?"
- Captura de b√∫squeda espec√≠fica: "¬øQu√© s√≠ntomas tiene Mar√≠a?"
- Captura de respuesta contextual del asistente m√©dico

#### Conversi√≥n de Formatos
- Captura del env√≠o de nota de voz (.ogg)
- Captura del proceso de conversi√≥n autom√°tica
- Captura del resultado final procesado

### Demostraci√≥n de la API

#### Endpoint de Health Check
```
GET http://localhost:8000/
```

#### Procesamiento de Audio
```
POST http://localhost:8000/process-audio
Content-Type: multipart/form-data
```

#### Chat Inteligente
```
POST http://localhost:8000/chat
Content-Type: application/json
{
  "question": "¬øCu√°ntos pacientes tienen fiebre?"
}
```

## Testing

### Ejecutar Todos los Tests
```bash
# Test de transcripci√≥n
python test/test_whisper.py

# Test de base de datos
python test/test_chroma.py

# Test completo de API
python test/test_api.py

# Test del chatbot
python test/test_chat_gemini.py

# Test del bot de Telegram
python test/test_telegram_bot.py
```

## Supuestos del Sistema

1. **Formato de Audio**: Soporta .wav, .mp3, .m4a, .flac, .ogg (con conversi√≥n autom√°tica)
2. **Idioma**: Transcripci√≥n optimizada para espa√±ol
3. **Informaci√≥n del Paciente**: Extracci√≥n autom√°tica de nombre, edad, g√©nero, s√≠ntomas
4. **Priorizaci√≥n**: Clasificaci√≥n autom√°tica de urgencia (alta/normal)
5. **Persistencia**: Datos almacenados en ChromaDB con directorio `database/vector_db/`
6. **Seguridad**: Variables de entorno para API keys sensibles
7. **Interfaz de Usuario**: Bot de Telegram como interfaz principal m√≥vil
8. **Nombres de Pacientes**: Opcional via descripci√≥n de archivo de audio

## Buenas Pr√°cticas Implementadas

### Arquitectura
- **Separaci√≥n de responsabilidades**: Servicios modulares y especializados
- **Inyecci√≥n de dependencias**: Configuraci√≥n centralizada
- **Manejo de errores**: Try-catch robusto en todas las operaciones
- **Logging**: Registro detallado de operaciones

### C√≥digo
- **Docstrings**: Documentaci√≥n completa de clases y m√©todos
- **Type hints**: Tipado est√°tico para mejor mantenibilidad
- **Modularizaci√≥n**: C√≥digo organizado en servicios espec√≠ficos
- **Tests**: Cobertura completa con tests unitarios e integraci√≥n

### Seguridad
- **Variables de entorno**: API keys en archivo .env
- **Validaci√≥n de entrada**: Pydantic para validaci√≥n de datos
- **Manejo de archivos**: Validaci√≥n de tipos y tama√±os
- **Directorio temporal**: Tests sin afectar datos reales

## Estructura del Proyecto

```
ElSol-Challenge/
‚îú‚îÄ‚îÄ main.py                 # Punto de entrada de la aplicaci√≥n
‚îú‚îÄ‚îÄ requirements.txt        # Dependencias del proyecto
‚îú‚îÄ‚îÄ README.md              # Documentaci√≥n principal
‚îú‚îÄ‚îÄ documentacion.md        # Documento t√©cnico ejecutivo
‚îú‚îÄ‚îÄ .env                   # Variables de entorno (no versionado)
‚îú‚îÄ‚îÄ .gitignore            # Archivos excluidos del versionado
‚îÇ
‚îú‚îÄ‚îÄ services/              # Servicios de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ transcription_service.py  # Servicio de transcripci√≥n (Whisper)
‚îÇ   ‚îú‚îÄ‚îÄ chat_service.py           # Servicio de chat con LLM (Gemini)
‚îÇ   ‚îú‚îÄ‚îÄ process_conversation.py   # Orquestador de conversaciones
‚îÇ   ‚îî‚îÄ‚îÄ telegram_bot.py           # Bot de Telegram (interfaz de usuario)
‚îÇ
‚îú‚îÄ‚îÄ database/              # Capa de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ vector_store_service.py   # Servicio principal de ChromaDB
‚îÇ   ‚îú‚îÄ‚îÄ search_service.py         # B√∫squedas sem√°nticas
‚îÇ   ‚îú‚îÄ‚îÄ patient_service.py        # Operaciones de pacientes
‚îÇ   ‚îî‚îÄ‚îÄ vector_db/               # Datos de ChromaDB (no versionado)
‚îÇ
‚îú‚îÄ‚îÄ utils/                 # Utilidades y configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py                 # Configuraci√≥n centralizada
‚îÇ   ‚îú‚îÄ‚îÄ setup_telegram_bot.py     # Script de configuraci√≥n del bot
‚îÇ   ‚îî‚îÄ‚îÄ configure_bot.py          # Utilidad de configuraci√≥n de tokens
‚îÇ
‚îú‚îÄ‚îÄ test/                  # Tests del sistema
‚îÇ   ‚îú‚îÄ‚îÄ test_api.py        # Tests de endpoints de API
‚îÇ   ‚îú‚îÄ‚îÄ test_whisper.py    # Tests de transcripci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ test_chroma.py     # Tests de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ test_chat_gemini.py # Tests del chatbot
‚îÇ   ‚îî‚îÄ‚îÄ test_telegram_bot.py # Tests del bot de Telegram
‚îÇ
‚îî‚îÄ‚îÄ pruebas/               # Archivos de audio de prueba (no versionado)
    ‚îú‚îÄ‚îÄ p_51994013_222.mp3
    ‚îî‚îÄ‚îÄ p_52015966_552.wav
```

## Configuraci√≥n Avanzada

### Variables de Entorno
```env
# Google Gemini API
GEMINI_API_KEY=tu_api_key_de_gemini

# Configuraci√≥n de FFmpeg
FFMPEG_PATH=C:\Program Files\ffmpeg\bin
```

### Configuraci√≥n de ChromaDB
- **Directorio de persistencia**: `database/vector_db/`
- **Colecciones**: `patients`, `conversations`, `symptoms`
- **Embeddings**: Autom√°ticos con ChromaDB

## Troubleshooting

### Problemas Comunes

1. **Error de FFmpeg**
   - Verificar que FFmpeg est√© instalado y en el PATH
   - Configurar ruta manual en `transcription_service.py`

2. **Error de API Key de Gemini**
   - Verificar que `GEMINI_API_KEY` est√© en el archivo `.env`
   - Confirmar que la API key sea v√°lida

3. **Error de transcripci√≥n**
   - Verificar formato de audio soportado
   - Confirmar que el archivo no est√© corrupto

4. **Error de base de datos**
   - Verificar permisos de escritura en `database/vector_db/`
   - Eliminar directorio y reiniciar para recrear colecciones

### Logs y Debugging
- Los logs detallados se muestran en la consola
- Usar `--debug` para informaci√≥n adicional
- Revisar logs de ChromaDB en `database/vector_db/`


## Estado del Proyecto

- **Proyecto**: ElSol Challenge - Medical Conversation API
- **Versi√≥n**: 1.0.0
- **√öltima actualizaci√≥n**: Agosto 2025
- **Estado**: ‚úÖ Completado y funcional
- **Caracter√≠sticas implementadas**:
  - ‚úÖ Transcripci√≥n de audio con Whisper (soporte .wav, .mp3, .m4a, .flac, .ogg)
  - ‚úÖ Almacenamiento vectorial con ChromaDB
  - ‚úÖ Chatbot inteligente con Google Gemini
  - ‚úÖ API REST completa con FastAPI
  - ‚úÖ Bot de Telegram como interfaz de usuario m√≥vil
  - ‚úÖ Conversi√≥n autom√°tica de formatos de audio
  - ‚úÖ Extracci√≥n de informaci√≥n estructurada de pacientes
  - ‚úÖ Tests unitarios e integraci√≥n
  - ‚úÖ Documentaci√≥n t√©cnica completa
  - ‚úÖ C√≥digo modular y bien documentado

## Pr√≥ximos Pasos

### Funcionalidades Futuras
- **Interfaz Web**: Dashboard administrativo para gesti√≥n de pacientes
- **Notificaciones**: Alertas autom√°ticas para casos de alta prioridad
- **An√°lisis Avanzado**: Reportes y estad√≠sticas detalladas
- **Integraci√≥n EMR**: Conexi√≥n con sistemas de historiales m√©dicos
- **M√∫ltiples Idiomas**: Soporte para transcripci√≥n en otros idiomas

### Mejoras T√©cnicas
- **Escalabilidad**: Implementaci√≥n de microservicios
- **Seguridad**: Autenticaci√≥n y autorizaci√≥n robusta
- **Monitoreo**: Logs centralizados y m√©tricas de rendimiento
- **CI/CD**: Pipeline de despliegue automatizado
- **Docker**: Containerizaci√≥n completa del sistema

## Contacto

- **Repositorio**: Fork de [David-Sol-AI/ElSol-Challenge](https://github.com/David-Sol-AI/ElSol-Challenge)
- **Documentaci√≥n T√©cnica**: Ver `documentacion.md` para detalles completos
- **Soporte**: Issues en el repositorio principal